<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     rwd_default
 * @copyright   Copyright (c) 2006-2014 X.commerce, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<style>
#trade-product-weight-table .price
{
	color: #464646;
    font-family: minion-pro,Verdana,sans-serif;
    font-size: 12px;
    font-style: italic;
    font-weight: 600;
    letter-spacing: 0.03em;
    line-height: 39px;
    text-align: left;
}
#tea-product-detail-section-1 #product-detail-img-info-container .product-info {
    padding-top: 90px;
    padding-bottom: 90px;
    padding-left: 10px;
    padding-right: 30px;
}
.grouped-items .row{
	padding: 0 !important;
	margin-bottom:5px !important;
}
.grouped-items .italic{
		color:white !important;
}
.grouped-items .col-xs-4{
	padding-left:28px !important;
}
.grouped-items .fa{
	display:none;
}
</style>

<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_product = $this->getProduct(); ?>
<?php
$isGiftcardType = $this->helper('catalogcustomiser')->isGiftcardType($_product);

if ($_product->getShortDescription()):
    $shortDescription = $_helper->productAttribute($_product, nl2br($_product->getDescription()), 'short_description');
endif; 
?>
<?php 
    $subscription_in_the_cart = 0;
    $allskus = array("SGP-ART-1M", "SGP-ART-3M", "SGP-ART-6M", "SGP-ART-12M", "SGP-GUR-1M", "SGP-GUR-3M", "SGP-GUR-6M", "SGP-GUR-12M","INT-ART-1M", "INT-ART-3M", "INT-ART-6M", "INT-ART-12M", "INT-GUR-1M", "INT-GUR-3M", "INT-GUR-6M", "INT-GUR-12M");
    $quote = Mage::getSingleton('checkout/session')->getQuote();
    foreach ($quote->getAllVisibleItems() as $item) {
        $itemsku = $item->getProduct()->getData('sku');        
        if(in_array($itemsku, $allskus)) {
            $subscription_in_the_cart = 1;
        }
    }

    $gift_in_the_cart = 0;
    $giftsku = array("testGiftCard2");
    foreach ($quote->getAllVisibleItems() as $item) {
        $itemsku = $item->getProduct()->getData('sku');        
        if(in_array($itemsku, $giftsku)) {
            $gift_in_the_cart = 1;
        }   
    }

    $_images = Mage::getModel('catalog/product')->load($_product->getId())->getMediaGalleryImages();
?>
<article id="page-product-detail-content-section" class="visible-md visible-lg">
    <div class="container-fluid has-breakpoint">
        <form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
            <input type="hidden" name="related_product" id="related-products-field" value="" />
            <div class="row">
                <div class="col-md-4">                
                    <!--
                         ____ ___ ____  _____ ____    _    ____
                        / ___|_ _|  _ \| ____| __ )  / \  |  _ \
                        \___ \| || | | |  _| |  _ \ / _ \ | |_) |
                         ___) | || |_| | |___| |_) / ___ \|  _ <
                        |____/___|____/|_____|____/_/   \_\_| \_\

                    -->
                    <div id="page-product-detail-sidebar">

                        <div id="page-product-detail-closeup">
                            <?php
                                $closeup_image_exist = false;
                                foreach ($_images as $_image): 
                                    if($_image->getLabel()=="closeup"):
                                        $closeup_image_exist = true;
                            ?>
                                <div class="manic-image-container">
                                    <img src="" data-image-desktop="<?php echo $this->helper('catalog/image')->init($this->getProduct(), 'thumbnail', $_image->getFile())->constrainOnly(false)->keepAspectRatio(true)->keepFrame(false)->resize(830, null); ?>" alt="<?php echo $this->htmlEscape($_image->getLabel()) ?>" title="<?php echo $this->htmlEscape($_image->getLabel()) ?>" class=""/>
                                </div>
                            <?php   endif;
                                endforeach;
                            ?>
                            <?php if(!$closeup_image_exist): // temporary ?>                                    
                                        <div class="manic-image-container">
                                            <img src="" data-image-desktop="<?php echo $this->getSkinUrl('images_cms/product-detail/product-detail-closeup.jpg'); ?>" alt="" title="" class=""/>
                                        </div>
                            <?php endif; ?>
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                          </div>
                          <div class="col-md-6">

                            <div id="page-product-detail-instructions">

                              <h2>Tea Origins & Brewing Instructions</h2>

                              <div class="detail-item-container">
                                <div class="detail-item">
                                  <h4>Tea Type</h4>
                                  <p>Sencha</p>
                                </div>
                                <div class="detail-item">
                                  <h4>Origin</h4>
                                  <p>Kagoshima Prefecture</p>
                                </div>
                                <div class="detail-item">
                                  <h4>harvest period</h4>
                                  <p>Spring</p>
                                </div>
                              </div> <!-- detail-item-container -->



                              <div class="detail-icon-container">
                                <div class="detail-icon">
                                  <div class="detail-icon-image icon-teapot"></div>
                                  <p><?php echo $_product->getTemperature(); ?></p>
                                </div>
                                <div class="detail-icon">
                                  <div class="detail-icon-image icon-clock"></div>
                                  <p><?php echo $_product->getTime(); ?></p>
                                </div>
                              </div>
                              
                              
                              
                              

                            </div> <!-- page-product-detail-instructions -->
                          </div>
                        </div>
                    </div> <!-- page-product-detail-sidebar -->
                </div>
                <div class="col-md-8">
                    <!--
                      ____ ___  _   _ _____ _____ _   _ _____
                     / ___/ _ \| \ | |_   _| ____| \ | |_   _|
                    | |  | | | |  \| | | | |  _| |  \| | | |
                    | |__| |_| | |\  | | | | |___| |\  | | |
                     \____\___/|_| \_| |_| |_____|_| \_| |_|

                    -->

                    <div id="page-product-detail-content">

                        <div id="page-product-detail-banner">
                            <?php
                                $banner_image_exist = false;
                                foreach ($_images as $_image): 
                                    if($_image->getLabel()=="banner"):
                                        $banner_image_exist = true;
                            ?>
                                <div class="manic-image-container">
                                    <img src="" data-image-desktop="<?php echo $this->helper('catalog/image')->init($this->getProduct(), 'thumbnail', $_image->getFile())->constrainOnly(false)->keepAspectRatio(true)->keepFrame(false)->resize(1163, null); ?>" alt="<?php echo $this->htmlEscape($_image->getLabel()) ?>" title="<?php echo $this->htmlEscape($_image->getLabel()) ?>" class=""/>
                                </div>
                            <?php   endif;
                                endforeach;
                            ?>
                            <?php if(!$banner_image_exist): // temporary ?>
                                <div class="manic-image-container">
                                    <img src="" data-image-desktop="<?php echo $this->getSkinUrl('images_cms/product-detail/product-detail-banner.jpg'); ?>" alt="" title="" class=""/>
                                </div>
                            <?php endif; ?>
                        </div> <!-- page-product-detail-banner -->


                        <div class="row">
                          <div class="col-md-1"></div>
                          <div class="col-md-11">

                            <div id="page-product-detail-copy">

                              <div class="copy-title">                            
                                <h1><?php echo $_product->getName(); ?></h1>
                                <h3><strong><?php echo $_product->getData('product_name_in_color'); ?></strong></h3>
                              </div>

                              <div class="copy-price red-version">
                                <ul>
                                  <li><?php echo $this->getPriceHtml($_product); ?></li>
                                  <li><?php echo $_product->getData('number_of_sachet'); ?> sachets</li>
                                  <li><?php echo number_format($_product->getData('weight'), 1); ?> g</li>
                                </ul>
                              </div>

                              <div class="row">
                                <div class="col-md-3">
                                  
                                  <div class="copy-desc red-version">
                                    <?php echo $shortDescription; ?>
                                  </div> <!-- copy-desc -->

                                </div>
                                <div class="col-md-1"></div>
                                <div class="col-md-8">

                                  <div class="detail-item-container">
                                    <div class="detail-item">
                                      <h4>Ingredients</h4>
                                      <p><?php echo $_product->getIngredients(); ?></p>
                                    </div>

                                    <div class="detail-item">
                                      <h4>Tea Makerâ€™s Note</h4>
                                      <p>Delicate, floral sweet aroma of white peach brings harmony to a smooth finish.</p>
                                    </div>
                                  </div> <!-- detail-item-container -->

                                </div>
                              </div>


                            </div> <!-- page-product-detail-copy -->

                          </div>
                        </div>

                        <div id="page-product-detail-form-container">

                          <div class="row">

                            <div class="col-md-1"></div>
                            <div class="col-md-11">


                              <div id="page-product-detail-form">
                                <?php if (!$this->hasOptions()):?>
                                    <div class="row">
                                        <?php if($_product->isSaleable()): ?>
                                            <?php echo $this->getChildHtml('addtocart') ?>
                                        <?php endif; ?>
                                        <?php echo $this->getChildHtml('addto') ?>
                                    </div>
                                    <?php echo $this->getChildHtml('extra_buttons') ?>
                                <?php elseif (!$_product->isSaleable()): ?>
                                    <div class="row">
                                        <?php echo $this->getChildHtml('addto') ?>
                                    </div>
                                <?php endif; ?>                            
                              </div> <!-- page-product-detail-form -->

                            </div> <!-- col-md-10 -->
                          </div> <!-- row -->
                        </div> <!-- page-product-detail-form-container -->

                        <div id="page-product-detail-content-image-container">
                          <div class="row">
                            <div class="col-md-1"></div>
                            <div class="col-md-6">
                              <div class="page-product-detail-content-image">
                                <?php
                                    $content_1_image_exist = false;
                                    foreach ($_images as $_image): 
                                        if($_image->getLabel()=="content-1"):
                                            $content_1_image_exist = true;
                                ?>
                                    <div class="manic-image-container">
                                        <img src="" data-image-desktop="<?php echo $this->helper('catalog/image')->init($this->getProduct(), 'thumbnail', $_image->getFile())->constrainOnly(false)->keepAspectRatio(true)->keepFrame(false)->resize(1163, null); ?>" alt="<?php echo $this->htmlEscape($_image->getLabel()) ?>" title="<?php echo $this->htmlEscape($_image->getLabel()) ?>" class=""/>
                                    </div>
                                <?php   endif;
                                    endforeach;
                                ?>
                                <?php if(!$content_1_image_exist): // temporary ?>
                                    <div class="manic-image-container">
                                        <img src="" data-image-desktop="<?php echo $this->getSkinUrl('images_cms/product-detail/product-detail-content-01.jpg'); ?>" alt="" title="" class=""/>
                                    </div>
                                <?php endif; ?>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="page-product-detail-content-image">
                                <?php
                                    $content_2_image_exist = false;
                                    foreach ($_images as $_image): 
                                        if($_image->getLabel()=="content-2"):
                                            $content_2_image_exist = true;
                                ?>
                                    <div class="manic-image-container">
                                        <img src="" data-image-desktop="<?php echo $this->helper('catalog/image')->init($this->getProduct(), 'thumbnail', $_image->getFile())->constrainOnly(false)->keepAspectRatio(true)->keepFrame(false)->resize(1163, null); ?>" alt="<?php echo $this->htmlEscape($_image->getLabel()) ?>" title="<?php echo $this->htmlEscape($_image->getLabel()) ?>" class=""/>
                                    </div>
                                <?php   endif;
                                    endforeach;
                                ?>
                                <?php if(!$content_2_image_exist): // temporary ?>
                                    <div class="manic-image-container">
                                        <img src="" data-image-desktop="<?php echo $this->getSkinUrl('images_cms/product-detail/product-detail-content-02.jpg'); ?>" alt="" title="" class=""/>
                                    </div>
                                <?php endif; ?>
                              </div>
                            </div>
                          </div>
                        </div> <!-- page-product-detail-content-image-container -->


                    </div> <!-- page-product-detail-content -->
                </div>
            </div>
        </form>
    </div>
</article>
<script type="text/javascript">
//<![CDATA[

    function do_update() {

        jQuery("#desktop-header-cart-menu").find(".cart-btn-value").removeClass('animated fadeIn').addClass('animated flipOutX');

        jQuery.ajax({
            url: '<?php echo $this->getUrl("discovertea/index/cartpreview"); ?>',
            dataType: 'json',
            type : 'get',
            success: function(data){

                // update product count in cart
                jQuery("#desktop-header-cart-menu").find(".cart-btn-value").text(data.cart_qty);
                // jQuery("#mobile-header-cart-btn-container").find(".count").text(data.cart_qty);

                jQuery("#desktop-header-cart-menu").find(".cart-btn-value").removeClass('animated flipOutX').addClass('animated fadeIn');

                jQuery('.desktop-header-cart-expand').html('');

                if(data.cart_qty > 0) {

                    jQuery.each(data.cart_items, function(key,value){

                        jQuery('.desktop-header-cart-expand').append('<ul class="desktop-header-cart-expand-content"><li><div class="manic-image-container"><img src="'+value.image+'" alt=""></div></li><li><p>'+value.qty+' x</p><p>'+value.name+'</p><p>'+value.name_in_color+'</p><p>'+value.row_price+'</p></li><li><a href="#" title="<?php echo $this->__('Remove item')?>" data-item-id="'+value.id+'" class="close-btn remove-item"></a></li></ul>');

                    });                    

                } else {

                    jQuery('.desktop-header-cart-expand').append('<ul class="desktop-header-cart-expand-content"><li class="empty-cart"><p>Your cart is empty.</p></li></ul>');

                }       

                jQuery('.desktop-header-cart-expand-summary').find('.sub-total-amount').html(data.cart_total);

                jQuery('#desktop-header-cart-expand-container').slideDown(300);
                window.header_cart_is_open = true;
                jQuery('#desktop-header-cart-expand-container').delay(5000).slideUp(300);

                setTimeout(function() {
                  window.header_cart_is_open = false;
                }, 5000);

                // var mobile_header = jQuery("#main-mobile-header").data('gryphon_mobile_header');
                // mobile_header.public_open_cart();
                //jQuery('#mobile-cart-expand-container').show();
                

                // jQuery('.mobile-cart-button').find('span').html(data.cart_qty);
                // jQuery('.cart-summary-data').find('.price').html(data.cart_total);
                // jQuery('.cart-summary-data').find('.count').html(data.cart_qty);
                // jQuery('.cart-summary-data span').html('<span class="price">'+data.cart_total+'</span> (<span class="count">'+data.cart_qty+'</span>)');                            
            }
        });                     
    }

    var productAddToCartForm = new VarienForm('product_addtocart_form');
    productAddToCartForm.submit = function(button, url) {
        if (this.validator.validate()) {
            var form = this.form;
            var oldUrl = form.action;

            if (url) {
               form.action = url;
            }
            var e = null;
            // try {
            //     this.form.submit();
            // } catch (e) {
            // }
            //Start of our new ajax code
            if(!url){
                url = jQuery('#product_addtocart_form').attr('action');
            }
            var data = jQuery('#product_addtocart_form').serialize();
            data += '&isAjax=1';   
            jQuery('#ajax_loader_product').show();

            var product_id = jQuery(form).find('input[name="product"]').val(); //gift card product id = 907

            var subscription_in_the_cart = <?php echo $subscription_in_the_cart; ?>;
            var gift_in_the_cart = <?php echo $gift_in_the_cart; ?>;


            var cart_count = <?php echo Mage::helper('checkout/cart')->getItemsCount(); ?>                     

            if(subscription_in_the_cart==1) {                                
                alert('This product cannot be purchased with other items in the cart. Please check out first before making this purchase.');
                //jQuery('span.ajax_msg_product').html('This product cannot be purchased with other items in the cart. Please check out first before making this purchase.').show();
                jQuery('#ajax_loader_product').hide();
            } else if(gift_in_the_cart==1 && product_id != 907) {
                alert('This product cannot be purchased with other items in the cart. Please check out first before making this purchase.');
                //jQuery('span.ajax_msg_product').html('This product cannot be purchased with other items in the cart. Please check out first before making this purchase.').show();
                jQuery('#ajax_loader_product').hide();                        
            } else if(product_id == 907 && gift_in_the_cart==0 && cart_count > 0) {
                alert('This product cannot be purchased with other items in the cart. Please check out first before making this purchase.');
                //jQuery('span.ajax_msg_product').html('This product cannot be purchased with other items in the cart. Please check out first before making this purchase.').show();
                jQuery('#ajax_loader_product').hide();                        
            }else {
                try {
                    jQuery.ajax({
                        url: url,
                        dataType: 'json',
                        type : 'post',
                        data: data,
                        success: function(data){
                            jQuery('#ajax_loader_product').hide();
                            console.log(data.status + ": " + data.message);

                            if(data.status=="ERROR") {
                                jQuery('span.ajax_msg_product').html(data.message).show().delay(5000).fadeOut();
                            }else {
                                do_update();
                                // jQuery('span.ajax_msg_product').html('Added to cart!').show().delay(5000).fadeOut();
                            }
                        },
                        error: function() {
                            console.log(jqXHR, textStatus, errorThrown);
                            do_update();
                            jQuery('span.ajax_msg_product').html('Added to cart!').show().delay(5000).fadeOut();
                        }
                    });
                } catch (e) {
                }                                
            }
            //End of our new ajax code    
            this.form.action = oldUrl;
            if (e) {
                throw e;
            }

            // if (button && button != 'undefined') {
            //     button.disabled = true;
            // }
        }
    }.bind(productAddToCartForm);

    productAddToCartForm.submitLight = function(button, url){
        if(this.validator) {
            var nv = Validation.methods;
            delete Validation.methods['required-entry'];
            delete Validation.methods['validate-one-required'];
            delete Validation.methods['validate-one-required-by-name'];
            // Remove custom datetime validators
            for (var methodName in Validation.methods) {
                if (methodName.match(/^validate-datetime-.*/i)) {
                    delete Validation.methods[methodName];
                }
            }

            if (this.validator.validate()) {
                if (url) {
                    this.form.action = url;
                }
                this.form.submit();
            }
            Object.extend(Validation.methods, nv);
        }
    }.bind(productAddToCartForm);
//]]>
</script>